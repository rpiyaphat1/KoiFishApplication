<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">รีเซ็ตรหัสผ่าน | Koi Monitor</title>
    <style>
        /* Base and Theme CSS (Adapted from Register/Login) */
        :root {
            --background-color: #ffffff;
            --text-color: #000000;
            --input-bg-color: #ffffff;
            --input-border-color: #ccc;
            --link-color: #007bff;
            --button-primary-bg: #4facfe;
            --button-primary-text: #ffffff;

            /* ตัวแปรสำหรับ Gradient Button */
            --reset-button-text: #ffffff;
            --reg-gradient: linear-gradient(to right, #4facfe 0%, #00f2fe 100%);
        }

        body.dark-theme {
            --background-color: #121212;
            --text-color: #e0e0e0;
            --input-bg-color: #1e1e1e;
            --input-border-color: #333;
            --link-color: #4da6ff;
            --button-primary-bg: #495057;
            --button-primary-text: #e0e0e0;

            /* ตัวแปรสำหรับ Gradient Button ใน Dark Mode */
            --reset-button-text: #121212;
            --reg-gradient: linear-gradient(to right, #6a85b6 0%, #bac8e0 100%);
        }

        /* Global Styles */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
        }

        .auth-container {
            width: 100%;
            max-width: 400px;
            padding: 40px 20px;
            text-align: center;
            position: relative;
        }

        /* Fixed Position Elements */
        .theme-toggle {
            position: absolute;
            top: 30px;
            left: 30px;
        }

        .lang-toggle-button {
            position: absolute;
            top: 30px;
            right: 30px;
            padding: 8px 12px;
            background-color: #f0f0f0;
            color: #343a40;
            border: 1px solid #ccc;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
            text-transform: uppercase;
            z-index: 10;
        }

        .dark-theme .lang-toggle-button {
            background-color: #333;
            color: #f0f0f0;
            border-color: #555;
        }

        /* Logo */
        .logo-fixed {
            margin-bottom: 30px;
        }

        .logo-fixed img {
            width: 200px;
            filter: drop-shadow(0 0 5px rgba(0, 0, 0, 0.1));
        }

        /* Form Layout */
        #reset-form {
            margin-top: 20px;
            background-color: var(--background-color);
            /* ใช้พื้นหลังตามธีมหลัก */
            padding: 0;
            /* ลบ padding/box-shadow เพื่อให้เข้ากับสไตล์ register */
            border-radius: 0;
            box-shadow: none;
        }

        /* Reset Title & Prompt */
        #title-reset {
            font-size: 1.8em;
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--text-color);
        }

        #reset-prompt {
            font-size: 0.9em;
            color: var(--text-color);
            opacity: 0.7;
            margin-bottom: 30px;
        }

        /* Input Styles - ADAPTED FROM REGISTER.HTML */
        .input-group {
            margin-bottom: 25px;
            /* 25px เหมือน register */
        }

        .input-group input {
            width: 100%;
            padding: 10px;
            /* 10px เหมือน register */
            /* FIX: สไตล์ Underline */
            border: none;
            border-bottom: 2px solid var(--input-border-color);
            background-color: transparent;
            border-radius: 0;
            box-sizing: border-box;
            color: var(--text-color);
            font-size: 1.1em;
            text-align: left;
        }

        /* Button Style (APPLIED GRADIENT/ROUNDED STYLE from register.html) */
        #btn-reset {
            width: 100%;
            padding: 15px;
            border: none;
            /* FIX: โค้งมน 25px เหมือน register */
            border-radius: 25px;
            font-size: 1.2em;
            font-weight: normal;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;

            /* FIX: ใช้ Gradient สีฟ้า */
            background-image: var(--reg-gradient);
            color: var(--reset-button-text);
            /* FIX: ใช้ Box Shadow เหมือน register */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            margin-top: 15px;
        }

        #btn-reset:active {
            transform: translateY(1px);
            opacity: 0.9;
        }

        /* Links (Footer) */
        .links {
            margin-top: 25px;
        }

        .links a {
            text-decoration: none;
            color: var(--link-color);
            font-weight: bold;
            margin: 0 5px;
            font-size: 0.9em;
            cursor: pointer;
        }

        /* Error Message Style */
        .error-message {
            color: #dc3545;
            font-weight: bold;
            margin-top: -10px;
            margin-bottom: 15px;
            text-align: center;
        }

        .hidden {
            display: none !important;
        }

        /* Theme Toggle Switch styles */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 25px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ffc107;
            transition: .4s;
            border-radius: 25px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 17px;
            width: 17px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            content: "\2600";
            font-size: 16px;
            color: #ffc107;
            text-shadow: 0 0 2px rgba(0, 0, 0, 0.2);
        }

        input:checked+.slider {
            background-color: #2c3e50;
        }

        input:checked+.slider:before {
            transform: translateX(25px);
            background-color: #2c3e50;
            color: white;
            content: "\1F319";
            font-size: 14px;
            text-shadow: none;
        }
    </style>
</head>

<body>
    <div class="auth-container">

        <div class="theme-toggle">
            <label class="toggle-switch">
                <input type="checkbox" id="theme-toggle-checkbox">
                <span class="slider"></span>
            </label>
        </div>
        <button id="lang-toggle-button" class="lang-toggle-button" onclick="toggleLanguage()">
            EN
        </button>

        <div class="logo-fixed">
            <img src="LogoKoi.png" alt="Koi Monitor Logo">
        </div>

        <h1 id="title-reset">Reset account password</h1>
        <p id="reset-prompt">Enter a new password for user@koi.com</p>

        <form id="reset-form" onsubmit="handleResetPassword(event)">

            <div class="input-group">
                <input type="password" id="new-password" name="password" required placeholder="Password">
            </div>

            <div class="input-group">
                <input type="password" id="confirm-password" name="confirm-password" required
                    placeholder="Confirm password">
            </div>

            <p id="password-mismatch-message" class="error-message hidden">
                Passwords do not match.
            </p>

            <button type="submit" id="btn-reset">Reset password</button>
        </form>

        <div class="links">
            <a href="index.html" id="link-login">← Back to Login</a>
        </div>

    </div>

    <script>
        // --- CONTENT MAPS ---
        const langContent = {
            'th': {
                title: 'รีเซ็ตรหัสผ่าน',
                prompt: 'ตั้งรหัสผ่านใหม่สำหรับ user@koi.com',
                passwordPlaceholder: 'รหัสผ่าน',
                confirmPasswordPlaceholder: 'ยืนยันรหัสผ่าน',
                btnReset: 'รีเซ็ตรหัสผ่าน',
                linkLogin: '← กลับไปหน้าเข้าสู่ระบบ',
                mismatchError: 'รหัสผ่านไม่ตรงกัน',
                alertSuccess: 'รีเซ็ตรหัสผ่านสำเร็จ! กรุณาเข้าสู่ระบบ'
            },
            'en': {
                title: 'Reset account password',
                prompt: 'Enter a new password for user@koi.com',
                passwordPlaceholder: 'Password',
                confirmPasswordPlaceholder: 'Confirm password',
                btnReset: 'Reset password',
                linkLogin: '← Back to Login',
                mismatchError: 'Passwords do not match.',
                alertSuccess: 'Password reset successful! Please log in.'
            }
        };

        // --- UTILS ---
        function getLang() { return localStorage.getItem('lang') || 'th'; }

        function toggleLanguage() {
            document.getElementById('password-mismatch-message').classList.add('hidden');
            let newLang = (getLang() === 'th') ? 'en' : 'th';
            localStorage.setItem('lang', newLang);
            applyThemeAndLangOnLoad();
        }

        function updateText(lang) {
            const content = langContent[lang];

            // NEW: ดึงอีเมลจาก URL
            const urlParams = new URLSearchParams(window.location.search);
            // FIX: ใช้ decodedURIComponent เพื่อให้อีเมลที่ถูกส่งมาแสดงผลถูกต้อง
            const userEmail = decodeURIComponent(urlParams.get('email') || 'user@koi.com');

            // Update Title, Prompt, and Button
            document.getElementById('page-title').textContent = content.title;
            document.getElementById('title-reset').textContent = content.title;
            // FIX: ใช้ .replace เพื่อแทรกอีเมลเข้าไปในข้อความ Prompt
            document.getElementById('reset-prompt').textContent = content.prompt.replace('user@koi.com', userEmail);
            document.getElementById('btn-reset').textContent = content.btnReset;
            document.getElementById('link-login').textContent = content.linkLogin;
            document.getElementById('lang-toggle-button').textContent = getLang().toUpperCase() === 'TH' ? 'EN' : 'TH';

            // Update Placeholder
            document.getElementById('new-password').placeholder = content.passwordPlaceholder;
            document.getElementById('confirm-password').placeholder = content.confirmPasswordPlaceholder;

            // Update Error Message (Ensure it matches the current language if visible)
            const errorElement = document.getElementById('password-mismatch-message');
            if (!errorElement.classList.contains('hidden')) {
                errorElement.textContent = content.mismatchError;
            }
        }

        // --- THEME/LANG INITIALIZATION ---
        const themeToggle = document.getElementById('theme-toggle-checkbox');

        themeToggle.addEventListener("change", function () {
            document.body.classList.toggle("dark-theme", this.checked);
            localStorage.setItem("theme", this.checked ? "dark" : "light");
            updateText(getLang());
        });

        function applyThemeAndLangOnLoad() {
            // Load Theme
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-theme');
                themeToggle.checked = true;
            } else {
                document.body.classList.remove('dark-theme');
                themeToggle.checked = false;
            }

            // Load Language
            updateText(getLang());
        }

        // --- RESET PASSWORD HANDLER (แก้ไขส่วนนี้) ---
        function handleResetPassword(e) {
            e.preventDefault();
            const lang = getLang();
            const content = langContent[lang];
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const errorMessageElement = document.getElementById('password-mismatch-message');

            errorMessageElement.classList.add('hidden');

            // 1. Password Match Validation
            if (newPassword !== confirmPassword) {
                errorMessageElement.textContent = content.mismatchError;
                errorMessageElement.classList.remove('hidden');
                return;
            }

            // 2. Mock Password Strength (Optional, basic length check)
            if (newPassword.length < 6) {
                // แก้ไขข้อความแจ้งเตือนให้เป็นภาษาอังกฤษเมื่ออยู่ในโหมด EN
                alert(lang === 'th' ? 'รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร' : 'Password must be at least 6 characters long.');
                return;
            }

            // 3. Success (Mock API call)
            // โค้ดที่นี่ทำให้เกิดการ Alert ก่อน 
            alert(content.alertSuccess);

            // 4. Redirect to Login (ใช้ setTimeout เพื่อให้แน่ใจว่า Alert ถูกปิดก่อนการ Redirect)
            setTimeout(() => {
                window.location.href = 'index.html?v=' + Date.now();
            }, 0);
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('password-mismatch-message').classList.add('hidden');
            applyThemeAndLangOnLoad();
            document.getElementById('reset-form').addEventListener('submit', handleResetPassword);
        });

        window.addEventListener('storage', (event) => {
            if (event.key === 'lang' || event.key === 'theme') {
                applyThemeAndLangOnLoad();
            }
        });
    </script>
</body>

</html>